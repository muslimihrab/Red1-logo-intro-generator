<!-- Main container with theme colors -->
<main class="min-h-screen bg-stone-50 text-stone-900 font-sans flex items-center justify-center p-4">

  <!-- Intro Splash Screen -->
  @if (showIntro()) {
    <div class="fixed inset-0 bg-stone-50 z-50 flex items-center justify-center fade-in" [class.fade-out]="!showIntro()">
      <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjIwIiBmaWxsPSIjZGMyNjI2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJjZW50cmFsIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNjAiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSI+UjE8L3RleHQ+PC9zdmc+" alt="Red1 LOGO & INTRO Generator Logo" class="w-48 h-48 md:w-64 md:h-64 object-contain">
    </div>
  }

  <!-- Main Application Content -->
  <div class="w-full max-w-4xl mx-auto transition-opacity duration-500" [class.opacity-0]="showIntro()" [class.opacity-100]="!showIntro()">
    <div class="text-center mb-8">
      <div class="flex justify-center items-center gap-4 mb-2">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjIwIiBmaWxsPSIjZGMyNjI2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJjZW50cmFsIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNjAiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSI+UjE8L3RleHQ+PC9zdmc+" alt="Red1 LOGO & INTRO Generator Logo" class="w-16 h-16 object-contain">
        <div>
          <h1 class="text-3xl md:text-4xl font-bold text-red-600">Red1</h1>
          <p class="text-lg text-stone-600">LOGO & INTRO Generator</p>
        </div>
      </div>
      <p class="text-stone-600 mt-2 max-w-2xl mx-auto">
        Create stunning intros and images with the power of AI.
      </p>
    </div>

    <!-- Mode Toggle -->
    <div class="mb-6 flex justify-center border-b border-stone-200">
      <button (click)="setMode('video')"
              class="px-6 py-3 text-lg font-semibold transition-colors duration-200"
              [class.text-stone-800]="mode() === 'video'"
              [class.border-b-2]="mode() === 'video'"
              [class.border-stone-800]="mode() === 'video'"
              [class.text-stone-500]="mode() !== 'video'">
        Intro Generator
      </button>
      <button (click)="setMode('image')"
              class="px-6 py-3 text-lg font-semibold transition-colors duration-200"
              [class.text-stone-800]="mode() === 'image'"
              [class.border-b-2]="mode() === 'image'"
              [class.border-stone-800]="mode() === 'image'"
              [class.text-stone-500]="mode() !== 'image'">
        Image Editor
      </button>
      <button (click)="setMode('assistant')"
              class="px-6 py-3 text-lg font-semibold transition-colors duration-200"
              [class.text-stone-800]="mode() === 'assistant'"
              [class.border-b-2]="mode() === 'assistant'"
              [class.border-stone-800]="mode() === 'assistant'"
              [class.text-stone-500]="mode() !== 'assistant'">
        AI Assistant
      </button>
    </div>

    <!-- Generation Form and Result -->
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-stone-200">

      <!-- ====================== -->
      <!--     INTRO GENERATOR    -->
      <!-- ====================== -->
      @if (mode() === 'video') {
        @if (isGeneratingVideo()) {
          <!-- Loading State -->
          <div class="flex flex-col items-center justify-center text-center p-8">
            <svg class="animate-spin h-12 w-12 text-stone-700 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h2 class="text-xl font-semibold text-stone-800">Generating Your Intro...</h2>
            <p class="text-stone-600 mt-2 animate-pulse">{{ generationStatus() }}</p>
          </div>
        } @else if (generatedVideoUrl(); as videoUrl) {
          <!-- Result State -->
          <div class="text-center">
            <h2 class="text-2xl font-bold text-stone-800 mb-4">Your Intro is Ready!</h2>
            
            <!-- Custom Video Player -->
            <div class="relative w-full rounded-lg shadow-md border border-stone-200 overflow-hidden group bg-black">
              <audio #audioPlayer [src]="uploadedSoundUrl()" loop></audio>
              <video #videoPlayer
                    [src]="videoUrl"
                    class="w-full h-full block cursor-pointer"
                    loop
                    autoplay
                    muted
                    (click)="togglePlayPause(videoPlayer, audioPlayer)"
                    (loadedmetadata)="onLoadedMetadata(videoPlayer)"
                    (timeupdate)="onTimeUpdate(videoPlayer)"
                    (play)="isPlaying.set(true)"
                    (pause)="isPlaying.set(false)">
              </video>
              <div class="absolute inset-0 flex items-center justify-center transition-opacity duration-300 opacity-0 group-hover:opacity-100" [class.opacity-0]="isPlaying()">
                  <button (click)="togglePlayPause(videoPlayer, audioPlayer)" class="p-4 bg-black/50 rounded-full text-white hover:bg-black/75 focus:outline-none focus:ring-2 focus:ring-white" aria-label="Play">
                      <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 14.7l6.8-4.7-6.8-4.7v9.4z"/></svg>
                  </button>
              </div>
              <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white p-3 flex items-center gap-3 transition-opacity duration-300 opacity-0 group-hover:opacity-100 focus-within:opacity-100">
                <button (click)="togglePlayPause(videoPlayer, audioPlayer)" class="p-2 rounded-full hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white" [attr.aria-label]="isPlaying() ? 'Pause' : 'Play'">
                  @if (isPlaying()) { <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4h3v12H5V4zm7 0h3v12h-3V4z"/></svg> } @else { <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 14.7l6.8-4.7-6.8-4.7v9.4z"/></svg> }
                </button>
                <span class="text-sm font-mono whitespace-nowrap">{{ formatTime(currentTime()) }}</span>
                <input type="range" class="w-full h-2 bg-white/30 rounded-lg appearance-none cursor-pointer accent-stone-700" [value]="currentTime()" [max]="duration()" (input)="onSeek($event, videoPlayer, audioPlayer)" aria-label="Video progress">
                <span class="text-sm font-mono whitespace-nowrap">{{ formatTime(duration()) }}</span>
                @if (uploadedSoundUrl()) {
                  <div class="flex items-center gap-2">
                    <button (click)="toggleMute(audioPlayer)" class="p-2 rounded-full hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white" [attr.aria-label]="isMuted() ? 'Unmute' : 'Mute'">
                      @if (isMuted()) { <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd"/></svg> } @else { <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3.076a1 1 0 011.09.217l3.707 3.707H17a1 1 0 011 1v4a1 1 0 01-1 1h-2.207l-3.707 3.707a1 1 0 01-1.707-.707V4a1 1 0 01.91-.924z"/></svg> }
                    </button>
                    <input type="range" class="w-24 h-2 bg-white/30 rounded-lg appearance-none cursor-pointer accent-stone-700" min="0" max="1" step="0.05" [value]="volume()" (input)="onVolumeChange($event, audioPlayer)" aria-label="Volume control">
                  </div>
                }
              </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
              <button (click)="downloadVideo()" class="w-full sm:w-auto bg-stone-800 text-white font-bold py-2 px-6 rounded-lg hover:bg-stone-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-stone-800 focus:ring-offset-2">Download Intro</button>
              <button (click)="resetVideoForm()" class="w-full sm:w-auto bg-stone-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-stone-600 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:ring-offset-2">Create Another Intro</button>
            </div>
          </div>
        } @else {
          <!-- Input Form State -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
            <!-- Left Column: Upload and Aspect Ratio -->
            <div class="flex flex-col gap-4">
              <div>
                <label class="block text-sm font-medium text-stone-700 mb-1">1. Upload Image or Logo (Optional)</label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-stone-300 border-dashed rounded-md">
                  <div class="space-y-1 text-center">
                    @if (uploadedFile(); as file) {
                      <img [src]="'data:' + file.mimeType + ';base64,' + file.base64" alt="Uploaded preview" class="mx-auto h-24 w-auto rounded-md object-cover">
                      <p class="text-xs text-stone-500 pt-2">{{ file.name }}</p>
                      <button (click)="uploadedFile.set(null)" class="text-xs text-red-600 hover:text-red-800">Remove</button>
                    } @else {
                      <svg class="mx-auto h-12 w-12 text-stone-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4 4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                      <div class="flex text-sm text-stone-600">
                        <label for="file-upload-video" class="relative cursor-pointer bg-white rounded-md font-medium text-stone-700 hover:text-stone-900 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-stone-700"><span>Upload a file</span><input id="file-upload-video" name="file-upload" type="file" class="sr-only" accept="image/*" (change)="onFileSelected($event)"></label><p class="pl-1">or drag and drop</p>
                      </div>
                      <p class="text-xs text-stone-500">PNG, JPG, GIF up to 10MB</p>
                    }
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-stone-700 mb-1">2. Upload Custom Sound (Optional)</label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-stone-300 border-dashed rounded-md">
                  <div class="space-y-1 text-center">
                    @if (uploadedSound(); as sound) {
                      <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 6l12-3" /></svg>
                      <p class="text-xs text-stone-500 pt-2">{{ sound.name }}</p>
                      <button (click)="uploadedSound.set(null); uploadedSoundUrl.set(null)" class="text-xs text-red-600 hover:text-red-800">Remove</button>
                    } @else {
                      <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 6l12-3" /></svg>
                      <div class="flex text-sm text-stone-600">
                        <label for="sound-upload-video" class="relative cursor-pointer bg-white rounded-md font-medium text-stone-700 hover:text-stone-900 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-stone-700"><span>Upload sound</span><input id="sound-upload-video" name="sound-upload" type="file" class="sr-only" accept="audio/*" (change)="onSoundSelected($event)"></label><p class="pl-1">or drag and drop</p>
                      </div>
                      <p class="text-xs text-stone-500">MP3, WAV up to 5MB</p>
                    }
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-stone-700 mb-1">3. Choose Aspect Ratio</label>
                <div class="flex gap-4">
                  <label class="flex items-center gap-2 cursor-pointer p-3 border rounded-lg transition-colors" [class.border-stone-700]="videoAspectRatio() === '16:9'" [class.bg-stone-100]="videoAspectRatio() === '16:9'" [class.border-stone-300]="videoAspectRatio() !== '16:9'"><input type="radio" name="videoAspectRatio" value="16:9" class="sr-only" (change)="videoAspectRatio.set('16:9')" [checked]="videoAspectRatio() === '16:9'"><div class="w-10 h-6 bg-stone-300 rounded-sm"></div><span class="font-medium">16:9</span><span class="text-xs text-stone-500">(Landscape)</span></label>
                  <label class="flex items-center gap-2 cursor-pointer p-3 border rounded-lg transition-colors" [class.border-stone-700]="videoAspectRatio() === '9:16'" [class.bg-stone-100]="videoAspectRatio() === '9:16'" [class.border-stone-300]="videoAspectRatio() !== '9:16'"><input type="radio" name="videoAspectRatio" value="9:16" class="sr-only" (change)="videoAspectRatio.set('9:16')" [checked]="videoAspectRatio() === '9:16'"><div class="w-6 h-10 bg-stone-300 rounded-sm"></div><span class="font-medium">9:16</span><span class="text-xs text-stone-500">(Portrait)</span></label>
                </div>
              </div>
            </div>
            <!-- Right Column: Design Controls -->
            <div class="flex flex-col gap-4">
              <div>
                <label for="subject" class="block text-sm font-medium text-stone-700 mb-1">4. Describe your Subject & Details</label>
                <input id="subject" name="subject" type="text" class="shadow-sm focus:ring-stone-700 focus:border-stone-700 block w-full sm:text-sm border-stone-300 rounded-md" placeholder="e.g., a red, happy cartoon dog" [value]="videoSubject()" (input)="videoSubject.set($event.target.value)">
                <p class="text-xs text-stone-500 mt-1">Be descriptive! You can include colors, mood, and actions.</p>
                <div class="mt-2">
                  <p class="text-xs text-stone-500 mb-2">Or try an example:</p>
                  <div class="flex flex-wrap gap-2">
                    @for (example of exampleVideoSubjects(); track example) { <button type="button" (click)="videoSubject.set(example)" class="px-3 py-1 bg-stone-100 text-stone-700 text-xs font-medium rounded-full hover:bg-stone-200 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stone-700">{{ example }}</button> }
                  </div>
                </div>
              </div>
               <div>
                <label class="block text-sm font-medium text-stone-700 mb-1">5. Choose a Style</label>
                <div class="grid grid-cols-1 gap-2">
                  <label class="flex items-center gap-3 cursor-pointer p-3 border rounded-lg transition-colors" [class.border-stone-700]="introStyle() === 'cinematic'" [class.bg-stone-100]="introStyle() === 'cinematic'" [class.border-stone-300]="introStyle() !== 'cinematic'"><input type="radio" name="introStyle" value="cinematic" class="sr-only" (change)="introStyle.set('cinematic')" [checked]="introStyle() === 'cinematic'"><span class="font-medium">Cinematic</span><span class="text-sm text-stone-500 ml-auto">Dramatic zoom & lighting</span></label>
                  <label class="flex items-center gap-3 cursor-pointer p-3 border rounded-lg transition-colors" [class.border-stone-700]="introStyle() === 'electric'" [class.bg-stone-100]="introStyle() === 'electric'" [class.border-stone-300]="introStyle() !== 'electric'"><input type="radio" name="introStyle" value="electric" class="sr-only" (change)="introStyle.set('electric')" [checked]="introStyle() === 'electric'"><span class="font-medium">Electric</span><span class="text-sm text-stone-500 ml-auto">High-energy reveal</span></label>
                  <label class="flex items-center gap-3 cursor-pointer p-3 border rounded-lg transition-colors" [class.border-stone-700]="introStyle() === 'watercolor'" [class.bg-stone-100]="introStyle() === 'watercolor'" [class.border-stone-300]="introStyle() !== 'watercolor'"><input type="radio" name="introStyle" value="watercolor" class="sr-only" (change)="introStyle.set('watercolor')" [checked]="introStyle() === 'watercolor'"><span class="font-medium">Watercolor</span><span class="text-sm text-stone-500 ml-auto">Artistic splash effect</span></label>
                </div>
              </div>
               <div>
                <label class="block text-sm font-medium text-stone-700 mb-1">6. Select Duration</label>
                <div class="grid grid-cols-3 gap-2">
                  <label class="flex flex-col items-center justify-center gap-1 cursor-pointer p-3 border rounded-lg transition-colors" [class.border-stone-700]="introDuration() === 'short'" [class.bg-stone-100]="introDuration() === 'short'" [class.border-stone-300]="introDuration() !== 'short'"><input type="radio" name="introDuration" value="short" class="sr-only" (change)="introDuration.set('short')" [checked]="introDuration() === 'short'"><span class="font-medium">Short</span><span class="text-xs text-stone-500">(~3s)</span></label>
                  <label class="flex flex-col items-center justify-center gap-1 cursor-pointer p-3 border rounded-lg transition-colors" [class.border-stone-700]="introDuration() === 'medium'" [class.bg-stone-100]="introDuration() === 'medium'" [class.border-stone-300]="introDuration() !== 'medium'"><input type="radio" name="introDuration" value="medium" class="sr-only" (change)="introDuration.set('medium')" [checked]="introDuration() === 'medium'"><span class="font-medium">Medium</span><span class="text-xs text-stone-500">(~5s)</span></label>
                  <label class="flex flex-col items-center justify-center gap-1 cursor-pointer p-3 border rounded-lg transition-colors" [class.border-stone-700]="introDuration() === 'long'" [class.bg-stone-100]="introDuration() === 'long'" [class.border-stone-300]="introDuration() !== 'long'"><input type="radio" name="introDuration" value="long" class="sr-only" (change)="introDuration.set('long')" [checked]="introDuration() === 'long'"><span class="font-medium">Long</span><span class="text-xs text-stone-500">(~8s)</span></label>
                </div>
              </div>
              <button (click)="generateVideo()" [disabled]="!videoSubject() || isGeneratingVideo()" class="mt-4 w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-bold text-white bg-stone-800 hover:bg-stone-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stone-800 disabled:bg-stone-300 disabled:cursor-not-allowed transition-colors duration-300">Generate Intro</button>
            </div>
          </div>
        }
      }

      <!-- ====================== -->
      <!--      IMAGE EDITOR      -->
      <!-- ====================== -->
      @if (mode() === 'image') {
        @if (isEditing()) {
          <!-- Loading State -->
          <div class="flex flex-col items-center justify-center text-center p-8">
            <svg class="animate-spin h-12 w-12 text-stone-700 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <h2 class="text-xl font-semibold text-stone-800">Editing Your Image...</h2>
            <p class="text-stone-600 mt-2">The AI is reimagining your creation, please wait.</p>
          </div>
        } @else if (editedImage(); as imageUrl) {
          <!-- Result State -->
          <div class="text-center">
            <h2 class="text-2xl font-bold text-stone-800 mb-4">Your New Image is Ready!</h2>
            <div class="flex justify-center">
                <img [src]="imageUrl" alt="Generated image" class="max-w-full max-h-[50vh] rounded-lg shadow-md border border-stone-200 object-contain">
            </div>
            <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
              <button (click)="downloadImage()" class="w-full sm:w-auto bg-stone-800 text-white font-bold py-2 px-6 rounded-lg hover:bg-stone-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-stone-800 focus:ring-offset-2">Download Image</button>
              <button (click)="resetImageEditor()" class="w-full sm:w-auto bg-stone-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-stone-600 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:ring-offset-2">Create Another Image</button>
            </div>
          </div>
        } @else {
          <!-- Input Form State -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
            <div class="flex flex-col gap-4">
              <div>
                <label for="image-upload-edit" class="block text-sm font-medium text-stone-700 mb-1">1. Upload Image</label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-stone-300 border-dashed rounded-md">
                  <div class="space-y-1 text-center">
                    @if (uploadedFile(); as file) {
                      <img [src]="'data:' + file.mimeType + ';base64,' + file.base64" alt="Uploaded preview" class="mx-auto h-24 w-auto rounded-md object-cover">
                      <p class="text-xs text-stone-500 pt-2">{{ file.name }}</p>
                      <button (click)="uploadedFile.set(null)" class="text-xs text-red-600 hover:text-red-800">Remove</button>
                    } @else {
                      <svg class="mx-auto h-12 w-12 text-stone-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4 4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                      <div class="flex text-sm text-stone-600">
                        <label for="file-upload-edit" class="relative cursor-pointer bg-white rounded-md font-medium text-stone-700 hover:text-stone-900 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-stone-700"><span>Upload a file</span><input id="file-upload-edit" name="file-upload" type="file" class="sr-only" accept="image/*" (change)="onFileSelected($event)"></label><p class="pl-1">or drag and drop</p>
                      </div>
                      <p class="text-xs text-stone-500">PNG, JPG, GIF up to 10MB</p>
                    }
                  </div>
                </div>
              </div>
               <div>
                <label class="block text-sm font-medium text-stone-700 mb-1">2. Choose Aspect Ratio</label>
                <div class="grid grid-cols-3 gap-2">
                  <label class="flex flex-col items-center justify-center gap-1 cursor-pointer p-2 border rounded-lg transition-colors" [class.border-stone-700]="imageAspectRatio() === '1:1'" [class.bg-stone-100]="imageAspectRatio() === '1:1'" [class.border-stone-300]="imageAspectRatio() !== '1:1'"><input type="radio" name="imageAspectRatio" value="1:1" class="sr-only" (change)="imageAspectRatio.set('1:1')" [checked]="imageAspectRatio() === '1:1'"><div class="w-8 h-8 bg-stone-300 rounded-sm"></div><span class="text-xs font-medium">1:1</span></label>
                  <label class="flex flex-col items-center justify-center gap-1 cursor-pointer p-2 border rounded-lg transition-colors" [class.border-stone-700]="imageAspectRatio() === '16:9'" [class.bg-stone-100]="imageAspectRatio() === '16:9'" [class.border-stone-300]="imageAspectRatio() !== '16:9'"><input type="radio" name="imageAspectRatio" value="16:9" class="sr-only" (change)="imageAspectRatio.set('16:9')" [checked]="imageAspectRatio() === '16:9'"><div class="w-12 h-7 bg-stone-300 rounded-sm"></div><span class="text-xs font-medium">16:9</span></label>
                  <label class="flex flex-col items-center justify-center gap-1 cursor-pointer p-2 border rounded-lg transition-colors" [class.border-stone-700]="imageAspectRatio() === '9:16'" [class.bg-stone-100]="imageAspectRatio() === '9:16'" [class.border-stone-300]="imageAspectRatio() !== '9:16'"><input type="radio" name="imageAspectRatio" value="9:16" class="sr-only" (change)="imageAspectRatio.set('9:16')" [checked]="imageAspectRatio() === '9:16'"><div class="w-7 h-12 bg-stone-300 rounded-sm"></div><span class="text-xs font-medium">9:16</span></label>
                </div>
              </div>
            </div>
            <div class="flex flex-col gap-4">
              <div>
                <label for="edit-prompt" class="block text-sm font-medium text-stone-700 mb-1">3. Describe Your Edits</label>
                <textarea id="edit-prompt" name="edit-prompt" rows="6" class="shadow-sm focus:ring-stone-700 focus:border-stone-700 block w-full sm:text-sm border-stone-300 rounded-md" placeholder="e.g., Change the background to a snowy mountain." [value]="editPrompt()" (input)="editPrompt.set($event.target.value)"></textarea>
                <div class="mt-2">
                  <p class="text-xs text-stone-500 mb-2">Or try an example:</p>
                  <div class="flex flex-wrap gap-2">
                    @for (example of exampleEditPrompts(); track example) { <button type="button" (click)="editPrompt.set(example)" class="px-3 py-1 bg-stone-100 text-stone-700 text-xs font-medium rounded-full hover:bg-stone-200 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stone-700">{{ example }}</button> }
                  </div>
                </div>
              </div>
              <button (click)="generateImage()" [disabled]="!uploadedFile() || !editPrompt() || isEditing()" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-bold text-white bg-stone-800 hover:bg-stone-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stone-800 disabled:bg-stone-300 disabled:cursor-not-allowed transition-colors duration-300">Generate Image</button>
            </div>
          </div>
        }
      }

      <!-- ====================== -->
      <!--     AI ASSISTANT       -->
      <!-- ====================== -->
      @if (mode() === 'assistant') {
        <div class="flex flex-col h-[65vh]">
          <!-- Conversation Area -->
          <div class="flex-grow overflow-y-auto p-4 space-y-4 bg-stone-100 rounded-t-lg">
            @for (message of conversation(); track $index) {
              @if (message.speaker === 'user') {
                <div class="flex justify-end">
                  <div class="bg-stone-700 text-white p-3 rounded-lg max-w-xs md:max-w-md shadow">
                    <p>{{ message.text }}</p>
                  </div>
                </div>
              } @else {
                <div class="flex justify-start">
                  <div class="bg-white text-stone-800 p-3 rounded-lg border border-stone-200 max-w-xs md:max-w-md shadow-sm">
                    <p>{{ message.text }}</p>
                  </div>
                </div>
              }
            }
            @if (isAssistantResponding()) {
              <div class="flex justify-start">
                  <div class="bg-white text-stone-800 p-3 rounded-lg border border-stone-200 shadow-sm">
                      <div class="flex items-center gap-2">
                          <span class="w-2 h-2 bg-stone-400 rounded-full animate-pulse [animation-delay:0s]"></span>
                          <span class="w-2 h-2 bg-stone-400 rounded-full animate-pulse [animation-delay:0.2s]"></span>
                          <span class="w-2 h-2 bg-stone-400 rounded-full animate-pulse [animation-delay:0.4s]"></span>
                      </div>
                  </div>
              </div>
            }
          </div>
          <!-- Recording Controls -->
          <div class="flex-shrink-0 p-4 bg-white border-t border-stone-200 rounded-b-lg flex flex-col items-center justify-center">
            <button (click)="toggleRecording()" 
                    class="w-20 h-20 rounded-full flex items-center justify-center transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2"
                    [class.bg-red-600]="isRecording()"
                    [class.hover:bg-red-700]="isRecording()"
                    [class.focus:ring-red-500]="isRecording()"
                    [class.shadow-xl]="isRecording()"
                    [class.scale-110]="isRecording()"
                    [class.bg-stone-700]="!isRecording()"
                    [class.hover:bg-stone-800]="!isRecording()"
                    [class.focus:ring-stone-600]="!isRecording()"
                    [disabled]="isAssistantResponding()"
                    [attr.aria-label]="isRecording() ? 'Stop Recording' : 'Start Recording'">
              <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                @if(isRecording()){
                  <path d="M5 5h10v10H5z"/>
                } @else {
                  <path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/>
                  <path d="M13 10a1 1 0 011 1v1a5 5 0 01-10 0v-1a1 1 0 011-1h1a1 1 0 011 1v.5a3 3 0 006 0V11a1 1 0 011-1z"/>
                }
              </svg>
            </button>
            <p class="mt-3 text-sm text-stone-500 h-5">
              @if(isRecording()) {
                <span class="text-red-600 animate-pulse">Recording... Click to stop.</span>
              } @else if (isAssistantResponding()) {
                <span>AI is thinking...</span>
              } @else {
                <span>Click the button to speak.</span>
              }
            </p>
          </div>
        </div>
      }

      <!-- Common Error Message -->
      @if (error(); as errorMessage) {
        <div class="mt-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
          <p class="font-bold">An Error Occurred</p>
          <p>{{ errorMessage }}</p>
        </div>
      }
    </div>
  </div>

</main>